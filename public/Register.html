<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PTC Admission</title>

<style>
body {
    background-color: #2e7d32;
    font-family: Arial, sans-serif;
    margin: 0;
    color: white;
}

.header {
    background-color: #1b5e20;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.header img {
    height: 60px;
}

.container {
    max-width: 600px;
    background: white;
    color: black;
    margin: 40px auto;
    padding: 30px;
    border-radius: 10px;
}

label {
    font-weight: bold;
    margin-top: 15px;
    display: block;
}

input, select {
    width: 100%;
    height: 40px;
    padding: 8px 10px;
    margin-top: 8px;
    box-sizing: border-box;
}

button {
    margin-top: 20px;
    padding: 12px;
    width: 100%;
    background-color: #2e7d32;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
</style>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QR Code Generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<div class="header">
    <img src="assets/Logo.png" alt="Logo">
    <h1>Pateros Technological College</h1>
</div>

<div class="container">
<h2 style="text-align:center;color:#2e7d32;">Admission Form</h2>

<form id="admissionForm">

<label>Given Name</label>
<input type="text" id="givenName" oninput="this.value = this.value.toUpperCase()" required>

<label>Last Name</label>
<input type="text" id="lastName" oninput="this.value = this.value.toUpperCase()" required>

<label>Middle Name</label>
<input type="text" id="middleName" oninput="this.value = this.value.toUpperCase()" required>

<label>Address</label>
<input type="text" id="address" oninput="this.value = this.value.toUpperCase()" required>

<label>Email</label>
<input type="email" id="email" required>

<label>Contact Number</label>
<input type="tel" id="contact" placeholder="0908-616-5254" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>

<!-- <label>Admission ID</label> -->
<input type="text" id="admissionId" readonly style="background-color: #f0f0f0; cursor: not-allowed;" hidden>

<label>Program</label>
<select id="program" required>
    <option value="">Select</option>
    <option>BS Information Technology</option>
    <option>BS Tourism Management</option>
    <option>BS Secondary Education</option>
    <option>TVL</option>
</select>

<button type="submit">Submit & Download PDF</button>
</form>

<!-- Hidden container for QR code -->
<div id="qrCodeContainer" style="display: none;"></div>
</div>

<script>
// Generate Admission ID function
function generateAdmissionId() {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const random = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
    return `PTC-${year}${month}${day}-${random}`;
}

document.getElementById("admissionForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const email = document.getElementById("email").value;

    // First, validate email on backend before generating PDF
    validateEmailFirst(email)
        .then(isValid => {
            if (!isValid.valid) {
                alert('Error: ' + isValid.message);
                return;
            }
            
            // Email is valid, proceed with exam config loading and PDF generation
            fetch('../api/exam_config.php?json')
                .then(response => response.json())
                .then(examConfig => {
                    processAdmissionSubmission(examConfig);
                })
                .catch(error => {
                    console.error('Error loading exam config:', error);
                    // Continue with default values if config doesn't load
                    const defaultConfig = {
                        exam_date: '2026-06-01',
                        exam_start_time: '09:00',
                        exam_end_time: '12:00',
                        exam_format: 'Online',
                        exam_location: 'Online',
                        exam_link: '[To be provided via email]',
                        exam_link_description: 'Will be provided 24 hours before the exam'
                    };
                    processAdmissionSubmission(defaultConfig);
                });
        })
        .catch(error => {
            console.error('Validation error:', error);
            alert('Error validating email. Please try again.');
        });
});

// Validate email on backend before PDF generation
function validateEmailFirst(email) {
    const formData = new FormData();
    formData.append('action', 'validate_email');
    formData.append('email', email);

    return fetch('../api/send_admission_email.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        return data;
    });
}

function processAdmissionSubmission(examConfig) {
    // Generate Admission ID on submission
    const admissionId = generateAdmissionId();
    document.getElementById('admissionId').value = admissionId;

    const givenName = document.getElementById("givenName").value;
    const lastName = document.getElementById("lastName").value;
    const middleName = document.getElementById("middleName").value;
    const address = document.getElementById("address").value;
    const email = document.getElementById("email").value;
    const contact = document.getElementById("contact").value;
    const program = document.getElementById("program").value;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const primaryColor = [46, 125, 50]; // #2e7d32 in RGB
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);

    // Header background
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.rect(0, 0, pageWidth, 45, 'F');

    // Header text
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("Pateros Technological College", pageWidth / 2, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text("Admission Form", pageWidth / 2, 28, { align: 'center' });

    // Reset to black text
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(11);

    let y = 55;

    // Admission ID - prominently displayed
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(46, 125, 50);
    doc.text("ADMISSION ID: " + admissionId, pageWidth / 2, y, { align: 'center' });
    y += 12;

    // Form fields
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    
    const fields = [
        { label: "Given Name:", value: givenName },
        { label: "Last Name:", value: lastName },
        { label: "Middle Name:", value: middleName },
        { label: "Address:", value: address },
        { label: "Email:", value: email },
        { label: "Contact Number:", value: contact },
        { label: "Program:", value: program }
    ];

    fields.forEach(field => {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(46, 125, 50);
        doc.text(field.label, margin, y);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        // Split long text to prevent overflow
        const maxWidth = contentWidth - 35;
        const splitText = doc.splitTextToSize(field.value, maxWidth);
        doc.text(splitText, margin + 35, y);
        y += (splitText.length > 1 ? 7 * splitText.length : 6);
    });

    // Add email letter content
    y += 10;
    doc.setLineWidth(0.5);
    doc.setDrawColor(46, 125, 50);
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    // Email letter
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(46, 125, 50);
    doc.text("ADMISSION LETTER", margin, y);
    y += 10;

    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);

    // Greeting
    const greeting = "Dear " + givenName + " " + lastName + ",";
    doc.text(greeting, margin, y);
    y += 8;

    // Email body
    const emailBody = [
        "Thank you for your interest in applying.",
        "",
        "Please proceed to the PTC grounds to pay the required application fee. Once your payment has been processed, you will receive an email containing the entrance exam link, as well as the scheduled date and time of your examination.",
        "",
        "If you have any questions, please feel free to contact us."
    ];

    emailBody.forEach(paragraph => {
        if (paragraph === "") {
            y += 3;
        } else {
            const lines = doc.splitTextToSize(paragraph, contentWidth - 5);
            doc.text(lines, margin, y);
            y += (lines.length * 5) + 2;
        }
    });

    y += 5;
    doc.setFont(undefined, 'normal');
    doc.text("Best regards,", margin, y);
    y += 6;
    doc.text("Admissions Office", margin, y);

    // Generate QR Code
    y += 15;
    doc.setFillColor(240, 240, 240);
    doc.rect(0, y, pageWidth, 1, 'F');
    y += 5;
    
    doc.setFont(undefined, 'bold');
    doc.setTextColor(46, 125, 50);
    doc.setFontSize(10);
    doc.text("QR Code:", margin, y);
    y += 8;

    // Generate QR code and add to PDF
    const qrData = "Admission ID: " + admissionId + "\nName: " + givenName + " " + lastName + "\nDate: " + new Date().toLocaleDateString();
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = '';
    
    new QRCode(qrContainer, {
        text: qrData,
        width: 100,
        height: 100,
        colorDark: "#2e7d32",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    // Wait for QR code to generate and then complete the PDF
    setTimeout(() => {
        const qrCanvas = qrContainer.querySelector('canvas');
        if (qrCanvas) {
            const qrImage = qrCanvas.toDataURL('image/png');
            doc.addImage(qrImage, 'PNG', margin, y, 40, 40);
        }

        // Footer with date
        const footerY = pageHeight - 15;
        doc.setFillColor(240, 240, 240);
        doc.rect(0, footerY, pageWidth, 15, 'F');
        doc.setFont(undefined, 'italic');
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text("Date Generated: " + new Date().toLocaleDateString(), pageWidth / 2, footerY + 8, { align: 'center' });

        // Save PDF
        const pdfData = doc.output('dataurlstring');
        const fileName = `PTC_Admission_Form_${admissionId}.pdf`;
        doc.save(fileName);

        // Send email with PDF and exam config
        sendEmailWithPDF(email, fileName, givenName, middleName, lastName, address, contact, program, admissionId, pdfData, examConfig);
    }, 500);
}

function sendEmailWithPDF(email, fileName, givenName, middleName, lastName, address, contact, program, admissionId, pdfData, examConfig) {
    // Prepare form data
    const formData = new FormData();
    formData.append('email', email);
    formData.append('firstName', givenName);
    formData.append('middleName', middleName);
    formData.append('lastName', lastName);
    formData.append('address', address);
    formData.append('contact', contact);
    formData.append('program', program);
    formData.append('admissionId', admissionId);
    formData.append('pdfData', pdfData);
    formData.append('examConfig', JSON.stringify(examConfig));

    // Send to backend PHP script
    fetch('../api/send_admission_email.php', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text(); // First get as text to debug
    })
    .then(text => {
        try {
            // Try to parse as JSON
            const data = JSON.parse(text);
            if (data.success) {
                alert('âœ“ Admission form submitted successfully!\n\nAdmission ID: ' + admissionId + '\n\nA confirmation email has been sent to:\n' + email);
                document.getElementById('admissionForm').reset();
                document.getElementById('admissionId').value = '';
            } else {
                // Show error message - do not reset form so user can correct it
                alert('Error: ' + (data.message || 'Unable to process admission form.'));
            }
        } catch (e) {
            // If not valid JSON, show error
            console.log("Response text:", text);
            alert('Error: Invalid response from server. Please try again.');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('Error submitting form: ' + error.message);
    });
}
</script>

</body>
</html>
