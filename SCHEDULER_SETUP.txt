AUTOMATED EMAIL SCHEDULER SETUP GUIDE
=====================================

This guide explains how to set up automatic scheduled email sending for PTC Entrance Exams.

---
OVERVIEW
--------

There are now two ways to send exam links:

1. SEND NOW: Send emails immediately (manual)
2. SCHEDULE FOR LATER: Schedule emails to be sent automatically at a future date/time

To use scheduled sending, you must set up a scheduler to check and send emails at the scheduled times.

---
SETUP INSTRUCTIONS FOR WINDOWS
-------------------------------

OPTION A: Using Windows Task Scheduler (Recommended for Windows Servers)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. FIND THE SCHEDULER SCRIPT
   - Location: e:\arquero_sofia\index\scheduler_check_emails.php
   - This script checks for pending emails and sends them

2. CREATE TASK SCHEDULER ENTRY
   - Press Windows Key + R, type "taskschd.msc" and press Enter
   - Click "Create Basic Task..." on the right panel
   - Fill in:
     * Name: "PTC Email Scheduler"
     * Description: "Automatically sends scheduled exam link emails"

3. SET THE TRIGGER
   - Click "Next"
   - Select "Recur: Daily" OR "Recur: On a schedule"
   - Click "Next"
   - Recurrence: Set to run every hour (or adjust frequency as needed)
   - Recommended: Set to run every 5 or 10 minutes for frequent checking
   - Click "Next"

4. SET THE ACTION
   - Select "Start a program"
   - In "Program/script" field, enter:
     C:\php\php.exe
     
     (Or wherever your PHP installation is located. Find it with: where php)

   - In "Add arguments" field, enter:
     scheduler_check_emails.php

   - In "Start in" field, enter:
     e:\arquero_sofia\index

   - Click "Next"

5. FINISH
   - Review your settings
   - Click "Finish"
   - The task is now created and will run automatically every 5/10 minutes

6. MONITOR THE SCHEDULER
   - Check logs in Windows Event Viewer
   - Check error_log file for PHP logging

---
SETUP INSTRUCTIONS FOR LINUX/SHARED HOSTING
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use crontab to run the scheduler periodically:

1. EDIT CRONTAB
   crontab -e

2. ADD LINE TO RUN SCHEDULER EVERY 5 MINUTES
   */5 * * * * /usr/bin/php /path/to/scheduler_check_emails.php >> /path/to/scheduler.log 2>&1

   (Replace /path/to/ with your actual paths)

3. SAVE AND EXIT
   Press Ctrl+X, then Y, then Enter

4. VERIFY
   crontab -l  (Should show your new cron job)

---
SETUP INSTRUCTIONS FOR MANUAL TESTING
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To manually run the scheduler and test if it works:

1. Open Command Prompt (Windows) or Terminal (Linux/Mac)

2. Navigate to the folder:
   cd e:\arquero_sofia\index

3. Run the scheduler:
   php scheduler_check_emails.php

4. Check the output:
   - Look at error_log file for detailed logs
   - Check if emails were sent

---
HOW IT WORKS - FLOW DIAGRAM
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Admin Panel                 Scheduled Directory              Scheduler Script
   |                              |                                |
   |-- Schedule Emails --> saves JSON files --> checks every 5 min |
   |   (stores in                  |                          (runs periodically)
   |    scheduled_emails/          |                                |
   |    folder)                    |-- If time passed ---------> Sends emails
   |                              |-- Updates status to "sent"
   |                              |-- Logs result
   
Database (admissions table)
   |
   |<-- Updates email_sent_date and exam_link_sent flag once email is sent

---
CONFIGURATION
~~~~~~~~~~~~~~

Default Settings:
- Admin Password: ptc_admin_2026 (used to authorize sending)
- Sender Email: arquero.sofia.tcu@gmail.com
- Sender Name: PTC Admissions
- Check Frequency: Every 5 minutes (customize as needed)
- Email Delay: 0.5 seconds between each email (to avoid rate limiting)

To change the email sending delay, edit scheduler_check_emails.php:
   Line 82: usleep(500000); // Change to higher value for slower sending

---
TROUBLESHOOTING
~~~~~~~~~~~~~~~~

Q: Emails not being sent at scheduled time?
A: 1) Check Windows Task Scheduler is running (check Services)
   2) Verify PHP path is correct
   3) Check error_log file for errors
   4) Ensure scheduler_check_emails.php has correct permissions

Q: Getting "PHP not found" error?
A: 1) Find PHP location: where php (Windows) or which php (Linux)
   2) Update the Task Scheduler action with correct PHP path

Q: Task Scheduler says "Last Run Result: 0x1"?
A: This usually means the task ran but output error. Check error_log file.

Q: How do I disable scheduled sending?
A: Delete the scheduled email JSON files from /scheduled_emails/ folder
   Or just don't use the "Schedule for Later" option, use "Send Now" instead

Q: Scheduled emails got sent but status still shows pending?
A: The scheduler updates the status file. If still stuck:
   1) Manually check /scheduled_emails/ folder
   2) Look for JSON files with status: "sent"
   3) Delete any files that are stuck

---
MONITORING
~~~~~~~~~~~

Check these locations for logs:

1. error_log file (in the project root)
   - Shows all email sending attempts
   - Shows scheduler runs and status

2. Windows Event Viewer (for Task Scheduler)
   - Shows when task ran and exit codes

3. /scheduled_emails/ folder
   - Shows pending and completed email batches
   - Each batch is a JSON file showing status

---
FAQ
~~~

Q: Can I change how often the scheduler runs?
A: Yes! In Windows Task Scheduler:
   1) Right-click your task
   2) Select "Properties"
   3) Go to "Triggers" tab
   4) Edit the trigger to change frequency

   Recommended frequencies:
   - Every 5 minutes: For frequent checking (good for active periods)
   - Every 30 minutes: For less frequent checking (saves resources)
   - Every 1 hour: For low frequency (uses minimal resources)

Q: What happens if the server is down at scheduled time?
A: The email won't send at exactly that time, but it WILL send when:
   1) Server comes back online
   2) Next scheduler check runs
   3) Scheduler detects the email is past its scheduled time
   4) Email is sent immediately

Q: Can multiple batches be scheduled?
A: Yes! You can schedule as many batches as you want.
   Each gets its own JSON file in /scheduled_emails/

Q: How do I unschedule an email?
A: Delete its JSON file from /scheduled_emails/ before the scheduled time.

---

For more help, check the error_log file in your project directory.
